version: 0.2  # 최신 CodeBuild 스펙 사용

env:
  parameter-store:
    AWS_REGION: "/bwapp/aws_region"
  variables:
    APP_NAME: "bWAPP"
    IMAGE_NAME: "bWAPP-app"
    TAG: "v1.0.${CODEBUILD_BUILD_NUMBER}"   # 빌드번호를 포함한 동적 태그

phases:
  install:
    runtime-versions:
      docker: 20
    commands:
      - echo "==== Install Phase ===="
      - echo "Region: $AWS_REGION"
      - echo "Build Number: $CODEBUILD_BUILD_NUMBER"
      - aws --version
      - docker --version

  build:
    commands:
      - echo "==== Build Phase ===="
      - echo "Building Docker image..."
      - docker build -t $IMAGE_NAME:$TAG .
      - docker tag $IMAGE_NAME:$TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:$TAG

  post_build:
    commands:
      - echo "==== Post-Build Phase ===="
      - echo "Logging in to ECR..."
      - aws ecr get-login-password --region $AWS_REGION | \
        docker login --username AWS --password-stdin \
        $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
      - echo "Pushing Docker image to ECR..."
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:$TAG
      - echo "Image successfully pushed!"
      - echo "IMAGE_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:$TAG" > imageDetail.txt

artifacts:
  files:
    - imageDetail.txt
  discard-paths: yes

cache:
  paths:
    - '/root/.docker/**/*'
